/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

package edu.stanford.facs.delaunay;
import edu.stanford.facs.drawing.DrawingFrame;
//import edu.stanford.facs.drawing.FloatingPoint;
import java.awt.geom.Point2D;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;

/**
 * $Id: Exp $
 * @author cate
 * Container class that will hold all the triangles that are created.
 */
public class TriangleTree {

   
    public Triangle treeRoot;
   // private Point[] newpoints;
   private DrawingFrame frame;
   private Delaunay model;
   
    

    
    public TriangleTree (Triangle tri, DrawingFrame frame, Delaunay model){
        this.frame = frame;
        this.treeRoot = tri;
        this.model = model;

      //  frame.addTree (this);

    }
    
    public Triangle containingTriangle(Point2D.Float xx) {
        Triangle tri=null;
//        if (treeRoot != null){
//            tri = treeRoot.containingTriangle (xx);
//        }

        tri = treeRoot;
//        System.out.println ("containing triangle for point " + xx.xf + ", "+ xx.yf);
        int ans = tri.contains (xx);
//        System.out.println ("\t(1) " + ans );

        
        if (tri.getLiveStatus() && ans == 1){ 
            return tri;
        }
        tri = tryDaughters (xx, tri.getDaughters());
        
        return tri;
        
    }
    
    public void traverseTree () {
        System.out.println ();
         System.out.println ("------------------------  Traverse Tree  -----------------");
         System.out.println ("  Root 0 "+ treeRoot.toString());
         int level = 1;
         for (Triangle tri: treeRoot.getDaughters()){
             if (tri != null){
//                 System.out.println (level + "  "+ tri.toString());
                 traverseTree (tri, level);
             }
         }
    }
    
    private void traverseTree (Triangle parent, int level){
        //System.out.println ("Parent " + level + "  " + parent.toString());
        level++;
        for (Triangle tri:  parent.getDaughters()){
            if (tri != null){
//                System.out.println (level + "  " + tri.toString());
                traverseTree (tri, level);
                System.out.println (level + "  "+ tri.toString());
            }
        }
        
        
    }
    
    private Triangle tryDaughters (Point2D.Float fpt, Triangle[] daughters){
        Triangle tri=null;
        int i=0;
        try {
        while (i < daughters.length){
            
//            if (daughters[i] != null){
////               System.out.println ("containing triangle for  " + fpt.xf + ", "+ fpt.yf + " -- "+ daughters[i].toString());     
//               System.out.println ( daughters[i].toString() );
//               System.out.println ("\t (1) "+ daughters[i].contains (fpt));
//
//            }
            if (daughters[i] == null) i++;
            else if (!daughters[i].getLiveStatus()){
                tri = tryDaughters(fpt, daughters[i].getDaughters());
                if (tri == null) i++;
                else
                    break;
            }
            else if(daughters[i].contains (fpt)==1 ){
//              else if(daughters[i].contains (fpt.xf, fpt.yf) ){
                tri = daughters[i];
                break;
                
            }
            else i++;
           // if (i == daughters.length) tri = null;

        }
//        if (tri != null)
//            System.out.println (tri.toString());
//        else
//            System.out.println (" no containing triangle was found ");
        } catch (StackOverflowError e){
            System.out.println (" Stack overflow");
            tri = null;
        }
        
        return tri;
    }

 

/**

    private Triangle findTriangleInTree (Point a, Point b, Point c, Triangle root){
        Triangle tri = null;
        boolean found = false;

        int id = a.hashCode() ^ b.hashCode() ^ c.hashCode();
        while (!found){
            if (root != null){
                Triangle[] daughters = root.getDaughters();
                for (int i=0; i < daughters.length; i++){
                    if (daughters[i] != null){
                        if (daughters[i].getId() == id){
                            found = true;
                            tri = daughters[i];
                            break;
                        }
                        else {
                            Point aa = new Point (daughters[i].xpoints[0], daughters[i].ypoints[0]);
                            Point bb = new Point (daughters[i].xpoints[1], daughters[i].ypoints[1]);
                            Point cc = new Point (daughters[i].xpoints[2], daughters[i].ypoints[2]);
                            findTriangleInTree (aa, bb, cc, daughters[i]);
                        }
                    }
                }
            }
        }
//        System.out.println ("findTriangle in Tree " + root.toString());
//        if (tri != null)
//        System.out.println  (tri.toString());
        return tri;
    }

    private Triangle whichDaughter (Triangle parent, Point a, Point b, Point c){
        Triangle[]daughters = parent.getDaughters();
        Triangle one = null;
        int id = a.hashCode()^ b.hashCode()^ c.hashCode();

            if (daughters[0] != null && daughters[0].getId() == id){
                one= daughters[0];
            }
            else if (daughters[1] != null && daughters[1].getId() == id){
                one =daughters[1];
            }
            else if (daughters[2] != null && daughters[2].getId() == id){
                one = daughters[2];
            }
            else {
                System.out.println (" couldn't find it ");
            }
        return one;
    }

   **/
    public void printTreeForR (Triangle root){
        
        File f = new File ("./printR.r");
        FileOutputStream fw = null;
        try {
        fw = new FileOutputStream (f);
        if (root != null){
            printTree (root.getDaughters(), fw);
//            Triangle[] daughters = root.getDaughters();
//            
//            for (Triangle tri: daughters){
//                // (tri != null && tri.getLiveStatus()){
//                if (tri != null){
//                    printTree (tri, fw);
////                    String s = tri.printForR();
////                    if (s != null || !s.equals(""))
////                        fw.write (s.getBytes());
//                }
//            }
        }
        fw.close();
        } catch (IOException e){
            System.out.println (" file io exception ");
        } finally {
            
        }
    }


    public void printTree(Triangle[] daughters, FileOutputStream fw) throws IOException {
     // System.out.print ("<------------------------ Print Tree -----------------> ");

//        if (root != null  && !root.getLiveStatus()) {
//            System.out.println ("PrintTree Parent" + root.toString());
//            Triangle[] daughters = root.getDaughters();
          
            for (Triangle tri : daughters){
                if ( tri != null) {
                    if (!tri.getLiveStatus()){
                        System.out.println ("daughters " +  " " +tri.toString());
                        printTree (tri.getDaughters(), fw);
//                    String s = tri.printForR();
//                    System.out.println (s);
//                    fw.write (s.getBytes());
                    }
               
                    else {
                        String s = tri.printForR();
                        System.out.println (s);
                        if (s != null && !s.equals(""))
                            fw.write (s.getBytes());
                    }
                }
            }
    }
    
  

    
}
